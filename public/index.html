<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PHP REST API With User Authentication DEMO</title>
  </head>

  <body class="text-center">
    <main>
      <h1>login</h1>
      <form method="post" action="./login.php" id="frmLogin">
        <label for="inputEmail" class="visually-hidden">Email address</label>
        <input
          type="text"
          id="inputEmail"
          class="inputEmail"
          placeholder="Email address or username"
          required
          autofocus=""
        />

        <label for="inputPassword">Password</label>
        <input
          type="password"
          id="inputPassword"
          class="inputPassword"
          placeholder="Password"
          required
        />

        <button type="submit">Sign in</button>
      </form>

      <h1>register</h1>
      <form method="post" action="./register.php" id="frmRegister">
        <label for="inputEmail">Email address</label>
        <input
          type="text"
          id="inputEmail"
          class="inputEmail"
          placeholder="Email address or username"
          required
          autofocus=""
        />

        <label for="inputPassword">Password</label>
        <input
          type="password"
          id="inputPassword"
          class="inputPassword"
          placeholder="Password"
          required
        />

        <button type="submit">register</button>
      </form>

      <button id="btnGetResource">check if verified</button>
      <button id="btnUpdate">update</button>
      <button id="btnLogout">logout</button>
    </main>

    <script>
      const loginForm = document.querySelector('#frmLogin');
      const registerForm = document.querySelector('#frmRegister');
      const btnGetResource = document.querySelector('#btnGetResource');
      const btnLogout = document.querySelector('#btnLogout');
      const btnUpdate = document.querySelector('#btnUpdate');
      const isLoggedIn = false;

      // login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch('./public/login.php', {
          method: 'POST',
          headers: {
            'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8',
          },
          body: JSON.stringify({
            email: loginForm.inputEmail.value,
            password: loginForm.inputPassword.value,
          }),
        });

        if (res.status >= 200 && res.status <= 299) {
          const responsedata = await res.text();
          const responsedatajson = JSON.parse(responsedata);
          console.log(responsedatajson.notes);
          storeJWT(responsedatajson.jwt);
        } else {
          // Handle errors
          console.log(res.status, res.statusText);
        }
      });

      // register
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch('./public/register.php', {
          method: 'POST',
          headers: {
            'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8',
          },
          body: JSON.stringify({
            email: registerForm.inputEmail.value,
            password: registerForm.inputPassword.value,
          }),
        });
        if(res.ok){
          console.log('registered')
        } else {
          console.log('failed')
        }
      });

      btnGetResource.addEventListener('click', async (e) => {
        const res = await fetch('./public/verify.php', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${localStorage.getItem('JWT')}`,
          },
        });
        console.log(res.text());
      });

      btnUpdate.addEventListener('click', async (e) => {
        const res = await fetch('./public/update.php', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${localStorage.getItem('JWT')}`,
          },
          body: JSON.stringify({ notes: { note1: 'yamotha' } }),
        });
        console.log(await res.text());
      });

      btnLogout.addEventListener('click', async (e) => {
        const res = await fetch('./public/logout.php', {
          method: 'POST',
        });
        console.log(res.text());
      });
    </script>
  </body>
</html>
